<!-- OTAProject/templates/dashboard/tourist.html -->
{% extends "base.html" %}

{% block title %}游客平台 - OTA系统{% endblock %}

{% block styles %}
.dashboard-container {
    height: 100vh;
    display: flex;
    flex-direction: column;
}
.content-container {
    flex: 1;
    display: flex;
    overflow: hidden;
}
.main-content {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
}
.map-container {
    height: 500px;
    border-radius: 5px;
    margin-bottom: 20px;
}
.route-card {
    margin-bottom: 15px;
    cursor: pointer;
}
.chat-window {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 350px;
    height: 500px;
    background: white;
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    display: none;
    border-radius: 10px;
    z-index: 1000;
}
.view-toggle-btn {
    padding: 8px 12px;
    background-color: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
}
.view-toggle-btn.active {
    background-color: #007bff;
    color: white;
    border-color: #007bff;
}
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">OTA游客平台</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-view="routes">旅游线路</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-view="bookings">我的行程</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            {{ user.username }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" id="chat-button">聊天</a></li>
                            <li><a class="dropdown-item" href="#" id="complaint-button">投诉</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="share-location-btn">分享位置</a></li>
                            <li><a class="dropdown-item" href="/logout/">退出登录</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 内容区 -->
    <div class="content-container">
        <!-- 线路视图 -->
        <div id="routes-view" class="main-content">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>旅游线路</h2>
                <div class="btn-group">
                    <button class="view-toggle-btn active" data-view="list"><i class="bi bi-list"></i> 列表</button>
                    <button class="view-toggle-btn" data-view="map"><i class="bi bi-map"></i> 地图</button>
                </div>
            </div>

            <!-- 列表视图 -->
            <div id="list-view" class="row">
                <!-- 路线卡片将动态生成 -->
            </div>

            <!-- 地图视图 -->
            <div id="map-view" style="display: none;">
                <div class="map-container" id="routes-map"></div>
            </div>
        </div>

        <!-- 我的行程视图 -->
        <div id="bookings-view" class="main-content" style="display: none;">
            <h2 class="mb-4">我的行程</h2>

            <ul class="nav nav-tabs mb-4">
                <li class="nav-item">
                    <a class="nav-link active" href="#" data-booking-status="all">全部</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-booking-status="pending">待确认</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-booking-status="confirmed">已确认</a>
                </li>
            </ul>

            <div id="bookings-list" class="row">
                <!-- 行程卡片将动态生成 -->
            </div>
        </div>
    </div>

    <!-- 聊天窗口 -->
    <div id="chat-window" class="chat-window">
        <!-- 聊天界面内容 -->
    </div>

    <!-- 线路详情模态框 -->
    <div class="modal fade" id="route-details-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="route-details-title">线路详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <div class="map-container" id="route-details-map"></div>
                    </div>
                    <h5>景点列表</h5>
                    <div id="route-points-list" class="list-group mb-4">
                        <!-- 景点列表将动态生成 -->
                    </div>
                    <h5>可选行程</h5>
                    <div id="route-itineraries" class="list-group mb-4">
                        <!-- 行程列表将动态生成 -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 投诉模态框 -->
    <div class="modal fade" id="complaint-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">提交投诉</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="complaint-form">
                        <div class="mb-3">
                            <label for="complaint-title" class="form-label">投诉标题</label>
                            <input type="text" class="form-control" id="complaint-title" required>
                        </div>
                        <div class="mb-3">
                            <label for="complaint-content" class="form-label">投诉内容</label>
                            <textarea class="form-control" id="complaint-content" rows="4" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="complaint-itinerary" class="form-label">相关行程</label>
                            <select class="form-control" id="complaint-itinerary">
                                <option value="">与行程无关</option>
                                <!-- 行程选项将动态生成 -->
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="submit-complaint-btn">提交投诉</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 初始化地图
    const routesMap = L.map('routes-map').setView([35.86166, 104.195397], 4);
    let routeDetailsMap = null;

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(routesMap);

    // 视图切换
    const navLinks = document.querySelectorAll('.nav-link[data-view]');
    const views = {
        'routes': document.getElementById('routes-view'),
        'bookings': document.getElementById('bookings-view')
    };

    navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();

            navLinks.forEach(l => l.classList.remove('active'));
            this.classList.add('active');

            const viewName = this.getAttribute('data-view');

            Object.values(views).forEach(v => v.style.display = 'none');
            views[viewName].style.display = 'block';

            if (viewName === 'routes') {
                routesMap.invalidateSize();
                loadRoutes();
            } else if (viewName === 'bookings') {
                loadBookings('all');
            }
        });
    });

    // 列表/地图视图切换
    const viewToggleBtns = document.querySelectorAll('.view-toggle-btn');
    const listView = document.getElementById('list-view');
    const mapView = document.getElementById('map-view');

    viewToggleBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            viewToggleBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');

            const viewType = this.getAttribute('data-view');

            if (viewType === 'list') {
                listView.style.display = 'flex';
                mapView.style.display = 'none';
            } else {
                listView.style.display = 'none';
                mapView.style.display = 'block';
                routesMap.invalidateSize();
            }
        });
    });

    // 行程状态筛选
    const bookingStatusLinks = document.querySelectorAll('.nav-link[data-booking-status]');

    bookingStatusLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();

            bookingStatusLinks.forEach(l => l.classList.remove('active'));
            this.classList.add('active');

            const status = this.getAttribute('data-booking-status');
            loadBookings(status);
        });
    });

    // 聊天按钮
    document.getElementById('chat-button').addEventListener('click', function() {
        document.getElementById('chat-window').style.display = 'block';
    });

    // 投诉按钮
    document.getElementById('complaint-button').addEventListener('click', function() {
        // 加载游客的行程用于投诉
        loadBookingsForComplaint();

        const modal = new bootstrap.Modal(document.getElementById('complaint-modal'));
        modal.show();
    });

    // 分享位置按钮
    document.getElementById('share-location-btn').addEventListener('click', function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;

                // 发送位置信息到服务器
                shareLocation(latitude, longitude);
            }, function(error) {
                alert('无法获取您的位置: ' + error.message);
            });
        } else {
            alert('您的浏览器不支持地理定位功能');
        }
    });

    // 提交投诉按钮
    document.getElementById('submit-complaint-btn').addEventListener('click', function() {
        const title = document.getElementById('complaint-title').value;
        const content = document.getElementById('complaint-content').value;
        const itineraryId = document.getElementById('complaint-itinerary').value;

        if (!title || !content) {
            alert('请填写投诉标题和内容');
            return;
        }

        submitComplaint(title, content, itineraryId);
    });

    // 初始化加载数据
    loadRoutes();

    // Helper functions
    function loadRoutes() {
        fetch('/api/routes/')
        .then(response => response.json())
        .then(data => {
            // 处理路线数据
        })
        .catch(error => console.error('Error loading routes:', error));
    }

    function loadBookings(status) {
        fetch(`/api/tourist/bookings/?status=${status}`)
        .then(response => response.json())
        .then(data => {
            // 处理预订数据
        })
        .catch(error => console.error('Error loading bookings:', error));
    }

    function loadBookingsForComplaint() {
        fetch('/api/tourist/bookings/?status=confirmed')
        .then(response => response.json())
        .then(data => {
            const selectElement = document.getElementById('complaint-itinerary');
            selectElement.innerHTML = '<option value="">与行程无关</option>';

            // 添加行程选项
        })
        .catch(error => console.error('Error loading bookings for complaint:', error));
    }

    function shareLocation(latitude, longitude) {
        fetch('/api/tourist/share-location/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ latitude, longitude })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('位置分享成功！');
            } else {
                alert('位置分享失败: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('分享位置时发生错误');
        });
    }

    function submitComplaint(title, content, itineraryId) {
        fetch('/api/tourist/complaints/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                title: title,
                content: content,
                itinerary_id: itineraryId || null
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('投诉提交成功！');
                bootstrap.Modal.getInstance(document.getElementById('complaint-modal')).hide();

                // 重置表单
                document.getElementById('complaint-form').reset();
            } else {
                alert('投诉提交失败: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('提交投诉时发生错误');
        });
    }

    // 获取CSRF Token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}