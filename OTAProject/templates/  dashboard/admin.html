<!-- OTAProject/templates/dashboard/admin.html -->
{% extends "base.html" %}

{% block title %}文旅局管理平台 - OTA系统{% endblock %}

{% block styles %}
.dashboard-container {
    height: 100vh;
    display: flex;
    flex-direction: column;
}
.content-container {
    flex: 1;
    display: flex;
    overflow: hidden;
}
.main-content {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
}
.chat-window {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 350px;
    height: 500px;
    background: white;
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    display: none;
    border-radius: 10px;
    z-index: 1000;
}
.stat-card {
    background-color: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}
.stat-number {
    font-size: 24px;
    font-weight: bold;
    color: #007bff;
}
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">OTA文旅局管理平台</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-view="statistics">运营统计</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-view="travel-agencies">旅行社管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-view="complaints">投诉处理</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            {{ user.username }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" id="chat-button">聊天</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/logout/">退出登录</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 内容区 -->
    <div class="content-container">
        <!-- 运营统计视图 -->
        <div id="statistics-view" class="main-content">
            <h2 class="mb-4">运营统计</h2>

            <div class="row">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div>旅行社数量</div>
                        <div class="stat-number" id="agency-count">-</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div>导游数量</div>
                        <div class="stat-number" id="guide-count">-</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div>游客数量</div>
                        <div class="stat-number" id="tourist-count">-</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div>线路数量</div>
                        <div class="stat-number" id="route-count">-</div>
                    </div>
                </div>
            </div>

            <h4 class="mt-4 mb-3">各旅行社报名情况</h4>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>旅行社名称</th>
                            <th>线路数</th>
                            <th>行程数</th>
                            <th>游客报名数</th>
                        </tr>
                    </thead>
                    <tbody id="agency-stats-table">
                        <!-- 旅行社统计将动态生成 -->
                    </tbody>
                </table>
            </div>

            <h4 class="mt-4 mb-3">热门线路报名情况</h4>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>线路名称</th>
                            <th>旅行社</th>
                            <th>行程数</th>
                            <th>游客报名数</th>
                        </tr>
                    </thead>
                    <tbody id="route-stats-table">
                        <!-- 线路统计将动态生成 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 旅行社管理视图 -->
        <div id="travel-agencies-view" class="main-content" style="display: none;">
            <h2 class="mb-4">旅行社管理</h2>

            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>旅行社名称</th>
                            <th>许可证号</th>
                            <th>联系方式</th>
                            <th>地址</th>
                            <th>线路数</th>
                            <th>导游数</th>
                        </tr>
                    </thead>
                    <tbody id="agencies-table">
                        <!-- 旅行社列表将动态生成 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 投诉处理视图 -->
        <div id="complaints-view" class="main-content" style="display: none;">
            <h2 class="mb-4">投诉处理</h2>

            <ul class="nav nav-tabs mb-4">
                <li class="nav-item">
                    <a class="nav-link active" href="#" data-complaint-status="all">全部</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-complaint-status="pending">待处理</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-complaint-status="processing">处理中</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-complaint-status="resolved">已解决</a>
                </li>
            </ul>

            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>投诉标题</th>
                            <th>投诉人</th>
                            <th>相关行程</th>
                            <th>提交时间</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="complaints-table">
                        <!-- 投诉列表将动态生成 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 聊天窗口 -->
    <div id="chat-window" class="chat-window">
        <!-- 聊天界面内容 -->
    </div>

    <!-- 投诉详情模态框 -->
    <div class="modal fade" id="complaint-detail-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="complaint-detail-title">投诉详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <h6>投诉内容</h6>
                        <p id="complaint-detail-content"></p>
                    </div>
                    <div class="mb-3">
                        <h6>处理回复</h6>
                        <textarea class="form-control" id="complaint-response" rows="4"></textarea>
                    </div>
                    <div class="mb-3">
                        <h6>处理状态</h6>
                        <select class="form-control" id="complaint-status">
                            <option value="pending">待处理</option>
                            <option value="processing">处理中</option>
                            <option value="resolved">已解决</option>
                            <option value="rejected">已驳回</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="save-complaint-btn">保存处理结果</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 视图切换
    const navLinks = document.querySelectorAll('.nav-link[data-view]');
    const views = {
        'statistics': document.getElementById('statistics-view'),
        'travel-agencies': document.getElementById('travel-agencies-view'),
        'complaints': document.getElementById('complaints-view')
    };

    navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();

            navLinks.forEach(l => l.classList.remove('active'));
            this.classList.add('active');

            const viewName = this.getAttribute('data-view');

            Object.values(views).forEach(v => v.style.display = 'none');
            views[viewName].style.display = 'block';

            if (viewName === 'statistics') {
                loadStatistics();
            } else if (viewName === 'travel-agencies') {
                loadTravelAgencies();
            } else if (viewName === 'complaints') {
                loadComplaints('all');
            }
        });
    });

    // 投诉状态筛选
    const complaintStatusLinks = document.querySelectorAll('.nav-link[data-complaint-status]');

    complaintStatusLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();

            complaintStatusLinks.forEach(l => l.classList.remove('active'));
            this.classList.add('active');

            const status = this.getAttribute('data-complaint-status');
            loadComplaints(status);
        });
    });

    // 聊天按钮
    document.getElementById('chat-button').addEventListener('click', function() {
        document.getElementById('chat-window').style.display = 'block';
    });

    // 保存投诉处理按钮
    document.getElementById('save-complaint-btn').addEventListener('click', function() {
        const complaintId = this.getAttribute('data-complaint-id');
        const response = document.getElementById('complaint-response').value;
        const status = document.getElementById('complaint-status').value;

        if (!response && (status === 'resolved' || status === 'rejected')) {
            alert('请填写处理回复');
            return;
        }

        updateComplaint(complaintId, response, status);
    });

    // 初始化加载数据
    loadStatistics();

    // Helper functions
    function loadStatistics() {
        fetch('/api/admin/statistics/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('agency-count').textContent = data.agency_count;
            document.getElementById('guide-count').textContent = data.guide_count;
            document.getElementById('tourist-count').textContent = data.tourist_count;
            document.getElementById('route-count').textContent = data.route_count;

            const agencyStatsTable = document.getElementById('agency-stats-table');
            agencyStatsTable.innerHTML = '';

            data.agency_statistics.forEach(stat => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${stat.agency_name}</td>
                    <td>${stat.route_count}</td>
                    <td>${stat.itinerary_count}</td>
                    <td>${stat.booking_count}</td>
                `;
                agencyStatsTable.appendChild(row);
            });

            const routeStatsTable = document.getElementById('route-stats-table');
            routeStatsTable.innerHTML = '';

            data.route_statistics.forEach(stat => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${stat.route_name}</td>
                    <td>${stat.agency_name}</td>
                    <td>${stat.itinerary_count}</td>
                    <td>${stat.booking_count}</td>
                `;
                routeStatsTable.appendChild(row);
            });
        })
        .catch(error => console.error('Error loading statistics:', error));
    }

    function loadTravelAgencies() {
        fetch('/api/admin/travel-agencies/')
        .then(response => response.json())
        .then(data => {
            const agenciesTable = document.getElementById('agencies-table');
            agenciesTable.innerHTML = '';

            data.travel_agencies.forEach(agency => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${agency.agency_name}</td>
                    <td>${agency.license_number}</td>
                    <td>${agency.phone}</td>
                    <td>${agency.address || '-'}</td>
                    <td>${agency.route_count}</td>
                    <td>${agency.guide_count}</td>
                `;
                agenciesTable.appendChild(row);
            });
        })
        .catch(error => console.error('Error loading travel agencies:', error));
    }

    function loadComplaints(status) {
        fetch(`/api/admin/complaints/?status=${status}`)
        .then(response => response.json())
        .then(data => {
            const complaintsTable = document.getElementById('complaints-table');
            complaintsTable.innerHTML = '';

            if (data.complaints.length === 0) {
                complaintsTable.innerHTML = '<tr><td colspan="6" class="text-center">暂无投诉记录</td></tr>';
                return;
            }

            data.complaints.forEach(complaint => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${complaint.title}</td>
                    <td>${complaint.tourist_name}</td>
                    <td>${complaint.itinerary_name || '-'}</td>
                    <td>${complaint.created_at}</td>
                    <td>
                        <span class="badge ${getBadgeClass(complaint.status)}">${complaint.status_display}</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-info view-complaint-btn" data-complaint-id="${complaint.id}">查看</button>
                    </td>
                `;
                complaintsTable.appendChild(row);

                row.querySelector('.view-complaint-btn').addEventListener('click', function() {
                    viewComplaintDetail(complaint.id);
                });
            });
        })
        .catch(error => console.error('Error loading complaints:', error));
    }

    function viewComplaintDetail(complaintId) {
        fetch(`/api/admin/complaints/${complaintId}/`)
        .then(response => response.json())
        .then(data => {
            const complaint = data.complaint;

            document.getElementById('complaint-detail-title').textContent = complaint.title;
            document.getElementById('complaint-detail-content').textContent = complaint.content;
            document.getElementById('complaint-response').value = complaint.response || '';
            document.getElementById('complaint-status').value = complaint.status;
            document.getElementById('save-complaint-btn').setAttribute('data-complaint-id', complaint.id);

            const modal = new bootstrap.Modal(document.getElementById('complaint-detail-modal'));
            modal.show();
        })
        .catch(error => console.error('Error loading complaint details:', error));
    }

    function updateComplaint(complaintId, response, status) {
        fetch(`/api/admin/complaints/${complaintId}/`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                response: response,
                status: status
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('投诉处理结果已保存');
                bootstrap.Modal.getInstance(document.getElementById('complaint-detail-modal')).hide();

                // 重新加载投诉列表
                const activeLink = document.querySelector('.nav-link[data-complaint-status].active');
                const status = activeLink ? activeLink.getAttribute('data-complaint-status') : 'all';
                loadComplaints(status);
            } else {
                alert('保存失败: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('保存投诉处理结果时发生错误');
        });
    }

    function getBadgeClass(status) {
        switch (status) {
            case 'pending':
                return 'bg-warning';
            case 'processing':
                return 'bg-info';
            case 'resolved':
                return 'bg-success';
            case 'rejected':
                return 'bg-danger';
            default:
                return 'bg-secondary';
        }
    }

    // 获取CSRF Token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}